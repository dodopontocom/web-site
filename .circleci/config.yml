version: 2.1

defaults: &defaults
  working_directory: /root/app
gcp-image: &gcp-image
  docker:
    - image: google/cloud-sdk
tf-image: &tf-image
  docker:
    - image: hashicorp/terraform:full

only-testing: &only-testing
    filters:
      branches:
        ignore:
          - develop
          - master
          - bugfix
          - patch
          - release
          - circleci
only-releasable: &only-releasable
    filters:
      branches:
        only:
          - develop
          - master
          - circleci
non-releasable: &non-releasable
    filters:
      branches:
        ignore:
          - develop
          - master
          - circleci

jobs:
  App Build Docker Image:
    <<: *defaults
    <<: *gcp-image
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: "Build and Push"
          command: "./.circleci/cicd-executor.sh"
  GCP GKE Provisioning:
    <<: *defaults
    <<: *tf-image
    steps:
      - checkout
      - run:
          name: "GCP GKE Node Pool Creation"
          command: "./.circleci/cicd-executor.sh"

  GCP Deploy App:
    <<: *defaults
    <<: *gcp-image
    steps:
      - checkout
      - run:
          name: "GCP Deploy App"
          command: "./.circleci/cicd-executor.sh"

workflows:
  version: 2.1
  
  gcloud_workflow:
    jobs:
      - App Build Docker Image:
          <<: *only-releasable
      - GCP GKE Provisioning:
          <<: *only-releasable
          requires:
            - App Build Docker Image
      - GCP Deploy App:
          <<: *only-releasable
          requires:
            - GCP GKE Provisioning